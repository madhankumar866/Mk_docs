#### Blocking  user agent Software ##
include /etc/nginx/blockuseragents.rules;


server {
        if ($blockedagent) {
        return 403;
            }   

listen 80;
server_name  www.quizzsquash.com quizzsquash.com;
return 301 https://$server_name$request_uri;
rewrite ^ $scheme://www.quizzsquash.com$request_uri? permanent;

}

server {

if ($scheme != "https") {
rewrite ^ https://www.quizzsquash.com$request_uri? permanent;
        }

listen 139.162.12.185:80;
listen 443 ssl;
server_name www.quizzsquash.com quizzsquash.com;
root   /home/sites/quizzsquash.com;
server_tokens off;
keepalive_timeout 65;
keepalive_requests 100000;
sendfile on;
tcp_nopush on;
tcp_nodelay on;
chunked_transfer_encoding       off;
client_max_body_size 12m;
client_body_buffer_size 1k;
client_header_buffer_size    1k;
large_client_header_buffers  2 1k;
output_buffers               1 32k;
postpone_output              1460;
client_header_timeout  3m;
client_body_timeout    3m;
send_timeout           3m;

####  ALLOW ONLY  GET, POST, and HEAD METHOD #####
if ($request_method !~ ^(GET|HEAD|POST)$) {
return 444;
}

   
   index           index.php;
   charset         utf-8;
   access_log      /var/log/nginx/quizzsquash_access.log;
   error_log       /var/log/nginx/quizzsquash_error.log;



######REWRITE RULE######
rewrite ^/aps_logics/$ /aps_logics.php last;
rewrite ^/politics/$ /politics.php last;
rewrite ^/puzzles/$ /puzzles.php last;
rewrite ^/history/$ /history.php last;
rewrite ^/image_quiz/$ /image_quiz.php last;
rewrite ^/result/$ /result.php last;
rewrite ^/category/$ /category.php last;
rewrite ^/question_intro/$ /question_intro.php last;
rewrite ^/quiz_questions/$ /quiz_questions.php last;
rewrite ^/finish/$ /finish.php last;
rewrite ^/image_quiz/$ /image_quiz.php last;
rewrite ^/flag_category/$ /flag_category.php last;
rewrite ^/image_questions_intro/$ /image_questions_intro.php last;
rewrite ^/image_questions/$ /image_questions.php last;
rewrite ^/image_result/$ /image_result.php last;
rewrite ^/other_quiz/$ /other_quiz.php last;
######REWRITE RULE######


##### Redirect from non www to www #######
if ($host !~ "^www." ) { rewrite ^/(.*)$ http://www.$host/$1 permanent; }


##### http user agent blocking ####
#if ($http_user_agent ~* LWP::Simple|BBBike|wget|msnbot|scrapbot|Jullo|Baiduspider) {
#return 403;
#}


#=======SSL setting
ssl_certificate               /etc/letsencrypt/live/www.quizzsquash.com/fullchain.pem;
ssl_certificate_key           /etc/letsencrypt/live/www.quizzsquash.com/privkey.pem;
ssl_protocols             SSLv3 TLSv1 TLSv1.1 TLSv1.2;
ssl_prefer_server_ciphers on;
ssl_ciphers "ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:ECDHE-ECDSA-DES-CBC3-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:DES-CBC3-SHA:!DSS";
ssl_session_cache         shared:SSL:10m;
ssl_session_timeout       10m;




location / {
index index.html index.php;
try_files $uri $uri/ /index.php?$args;
expires 30d;    
}


#### Denying Hidden File Access####

location ~ /\. {
deny all;
access_log off;
log_not_found off;
    }
###Cache Purpose##
location ~* ^.+\.(css|js)$ {
rewrite ^(.+)\.(\d+)\.(css|js)$ $1.$3 last;
expires 31536000s;
access_log off;
log_not_found off;
add_header Pragma public;
add_header Cache-Control "max-age=31536000, public";
        }
location ~* \.(asf|asx|wax|wmv|wmx|avi|bmp|class|divx|doc|docx|eot|exe|gif|gz|gzip|ico|jpg|jpeg|jpe|mdb|mid|midi|mov|qt|mp3|m4a|mp4|m4v|mpeg|mpg|mpe|mpp|odb|odc|odf|odg|odp|ods|odt|ogg|ogv|otf|pdf|png|pot|pps|ppt|pptx|ra|ram|svg|svgz|swf|tar|t?gz|tif|tiff|ttf|wav|webm|wma|woff|wri|xla|xls|xlsx|xlt|xlw|zip)$ {
        expires 31536000s;
        access_log off;
        log_not_found off;
        add_header Pragma public;
        add_header Cache-Control "max-age=31536000, public";
        }
###END##
        open_file_cache max=1000 inactive=20s;
        open_file_cache_valid 30s;
        open_file_cache_min_uses 5;
        open_file_cache_errors off;

location ~.*\.(gif|jpg|png|jpge)$ {
valid_referers none blocked quizzsquash.com www.quizzsquash.com ~\.google\. ~\.yahoo\. ~\.bing\. ~\.facebook\. ~\.fbcdn\.;
if ($invalid_referer) {

    return 403;
 }
}

#Prevention of excuting php scripts inside the upload and files directory ##

location ~* /(?:uploads|files)/.*\.(html|htm|shtml|php|js|swf|py|jsp|asp|sh|cgi)$
{
    deny all;
}

###You dont want that users are able to executing scripts from there
location ~* wp-admin/includes { 
   deny all; 
 }


location ~* wp-includes/theme-compat/ {
   deny all; 
 }

location ~* wp-includes/js/tinymce/langs/.*.php {
   deny all; 
 }

location /wp-includes/ {
   internal; 
 }

###You dont want that users are able to executing scripts from there


## CGI Malicious attackers might want to execute or mask their viruses as CGI scripts of different languages #

location ~* .(pl|cgi|py|sh|lua|asp)$ {
        return 444;
}

##### Prevention of spammers are trying to put comment and disable  our wordpress version #

location ~* /(wp-config.php|readme.html|license.txt|nginx.conf) {
    deny all;
}

##### Wordpress application on my iPhone you can enable it #

location /xmlrpc.php {
 deny all;
}

###Prevent brute force attacks on your Wordpress administration#

## Block SQL injections
    set $block_sql_injections 0;
    if ($query_string ~ "union.*select.*\(") {
        set $block_sql_injections 1;
    }
    if ($query_string ~ "union.*all.*select.*") {
        set $block_sql_injections 1;
    }
    if ($query_string ~ "concat.*\(") {
        set $block_sql_injections 1;
    }
    if ($block_sql_injections = 1) {
        return 403;
    }
## Block common exploits
    set $block_common_exploits 0;
    if ($query_string ~ "(<|%3C).*script.*(>|%3E)") {
        set $block_common_exploits 1;
    }
    if ($query_string ~ "GLOBALS(=|\[|\%[0-9A-Z]{0,2})") {
        set $block_common_exploits 1;
    }
    if ($query_string ~ "_REQUEST(=|\[|\%[0-9A-Z]{0,2})") {
        set $block_common_exploits 1;
    }
    if ($query_string ~ "proc/self/environ") {
        set $block_common_exploits 1;
    }
    if ($query_string ~ "mosConfig_[a-zA-Z_]{1,21}(=|\%3D)") {
        set $block_common_exploits 1;
    }
    if ($query_string ~ "base64_(en|de)code\(.*\)") {
        set $block_common_exploits 1;
    }
    if ($block_common_exploits = 1) {
        return 403;
    }
## Block file injections
    set $block_file_injections 0;
    if ($query_string ~ "[a-zA-Z0-9_]=http://") {
        set $block_file_injections 1;
    }
    if ($query_string ~ "[a-zA-Z0-9_]=(\.\.//?)+") {
        set $block_file_injections 1;
    }
    if ($query_string ~ "[a-zA-Z0-9_]=/([a-z0-9_.]//?)+") {
        set $block_file_injections 1;
    }
    if ($block_file_injections = 1) {
        return 403;
    }

#### Allow multiple IPs access to wp-admin & wp-login.php ###
rewrite /wp-admin$ $scheme://$host$uri/ permanent;

location /wp-admin {
    allow 14.98.54.90;
    allow 113.193.28.102;
    deny all;
}

location ~* ^/wp-login.php$ {
    allow 14.98.54.90;
    allow 113.193.28.102;
    deny all;
    try_files $uri =404;
    fastcgi_split_path_info ^(.+\.php)(/.+)$;
    include fastcgi_params;
    fastcgi_index index.php;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    fastcgi_pass 127.0.0.1:9000;
}
#### Allow multiple IPs access to wp-admin & wp-login.php ###


location ~ \.php$ {
        try_files $uri =404;
        root /home/sites/quizzsquash.com;
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include       fastcgi_params;
        fastcgi_pass  127.0.0.1:9000;
        fastcgi_index index.php;
   }
gzip on;
            gzip_static on;
            gzip_vary on;
            gzip_comp_level 6;
            gzip_buffers     4 4k;
            gzip_types application/x-javascript text/css application/javascript text/javascript text/plain text/xml application/json application/vnd.ms-fontobject application/x-font-opentype application/x-font-truetype application/x-font-ttf application/xml font/eot font/opentype font/otf image/svg+xml image/vnd.microsoft.icon;
            gzip_disable "MSIE [1-6]\.";
            gzip_proxied    no-cache no-store private expired auth;
            gzip_min_length 1000;

}
